name: Deploy to GCP VM

on:
  push:
    branches:
      - gcp

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v2

      # Step 2: Set up GCP credentials
      - name: Authenticate with GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      # Step 3: Set up GCloud CLI
      - name: Set up GCloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: delta-prop-shop

      # Step 4: Deploy to GCP VM
      - name: Deploy to GCP VM
        env:
          PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_USER: ${{ secrets.SSH_USER }}
          VM_IP: ${{ secrets.VM_IP }}
        run: |
          # Create SSH directory
          mkdir -p ~/.ssh
          
          # Save the private key
          echo "$PRIVATE_KEY" | tr -d '\r' > ~/.ssh/private_key.pem
          
          # Set correct permissions for the private key
          chmod 600 ~/.ssh/private_key.pem
          
          # Test SSH connectivity
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/private_key.pem Muhammad@34.122.154.116 exit
          
          # Deploy the application
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/private_key.pem Muhammad@34.122.154.116 << 'EOF'
            set -e
            sudo ufw reload
          
            # Navigate to the application directory
            cd fastapi
            # Navigate to the application directory
            cd /home/muhammad/fastapi
          
            # Verify the .env file
            if [ ! -f .env ]; then
              echo ".env file missing at /home/muhammad/fastapi/.env. Deployment aborted." && exit 1
            else
              echo ".env file found. Proceeding with deployment."
            fi
          
            # Pull the latest code
            sudo git fetch --all
            sudo git reset --hard origin/gcp
            sudo git pull origin gcp
          
            # Build and run the Docker containers
            sudo docker-compose down
            sudo docker-compose up --build -d
          
            sudo ufw reload
          EOF
          
          # Clean up the private key
          rm -f ~/.ssh/private_key.pem
