name: Deploy to GCP

on:
  push:
    branches:
      - main  # Trigger deployment on pushes to the 'main' branch.

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout the repository
    - name: Checkout code
      uses: actions/checkout@v2

    # Step 2: Set up GCP credentials
    - name: Set up GCP credentials
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: delta-prop-shop
        credentials: ${{ secrets.GCP_CREDENTIALS }}

    # Step 3: Set up GCloud CLI
    - name: Set up GCloud CLI
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: delta-prop-shop

    # Step 4: SSH into the VM and run deployment commands
    - name: Deploy to GCP VM
      env:
        PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      run: |
       # Create SSH directory
        mkdir -p ~/.ssh
        
        # Remove potential carriage return characters from the private key
        echo "$PRIVATE_KEY" | tr -d '\r' > ~/.ssh/private_key.pem
        
        # Set appropriate permissions on the private key file
        chmod 600 ~/.ssh/private_key.pem
    
        # Test SSH connectivity
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/private_key.pem Muhammad@34.122.154.116 exit
        
        # Run deployment commands on the remote VM
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/private_key.pem Muhammad@34.122.154.116 << EOF
          sudo ufw allow ssh
          sudo ufw enable
          sudo ufw reload
          cd fastapi
          git fetch
          git checkout main
          git pull origin main
          if [ ! -f .env ]; then
            echo "Environment file not found. Please create it manually." && exit 1
          fi
          sudo docker-compose up --build -d
          sudo ufw reload
        EOF
        
        # Clean up the private key
        rm -f ~/.ssh/private_key.pem