name: Deploy to GCP

on:
  push:
    branches:
      - main  # Trigger the deployment only on pushes to the 'main' branch.

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout the repository
    - name: Checkout code
      uses: actions/checkout@v2

    # Step 2: Authenticate with Google Cloud using the auth action
    - name: Authenticate with GCP
      uses: google-github-actions/auth@v0
      with:
        credentials_json: ${{ secrets.GCP_CREDENTIALS }}

    # Step 3: Set up GCloud CLI (authentication is now handled)
    - name: Set up GCloud CLI
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: delta-prop-shop

    # Step 4: SSH into the VM and run deployment commands
    - name: Deploy to GCP VM
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H 34.122.154.116 >> ~/.ssh/known_hosts

        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa user@34.122.154.116 << EOF
          # Step 4.1: Allow SSH through UFW
          sudo ufw allow ssh
          sudo ufw enable
          sudo ufw reload
          
          # Step 4.2: Navigate to the project directory
          cd fastapi

          # Step 4.3: Fetch and check out the main branch
          git fetch
          git checkout main

          # Step 4.4: Pull the latest code
          git pull origin main

          # Step 4.5: Check for the .env file
          if [ ! -f .env ]; then
            echo "Environment file not found. Please create it manually." && exit 1
          fi

          # Step 4.6: Build and start the Docker containers
          sudo docker-compose up --build -d
          
          # Step 4.7: Reload UFW rules
          sudo ufw reload
        EOF
